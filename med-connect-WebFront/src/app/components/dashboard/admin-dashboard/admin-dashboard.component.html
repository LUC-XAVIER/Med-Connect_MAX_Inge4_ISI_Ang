<div class="admin-root">
  <header class="admin-header">
    <div>
      <h1>Admin Control Center</h1>
      <p>Manage doctor approvals and monitor platform stats</p>
    </div>
    <button class="logout-btn" (click)="logout()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
      </svg>
      Logout
    </button>
  </header>

  <main class="admin-main">
    <section class="cards">
      <div class="card gradient-blue">
        <p class="label">Total Doctors</p>
        <h2>{{ stats?.totalDoctors ?? '–' }}</h2>
      </div>
      <div class="card gradient-green">
        <p class="label">Verified Doctors</p>
        <h2>{{ stats?.verifiedDoctors ?? '–' }}</h2>
      </div>
      <div class="card gradient-orange">
        <p class="label">Unverified Doctors</p>
        <h2>{{ stats?.unverifiedDoctors ?? '–' }}</h2>
      </div>
      <div class="card gradient-purple">
        <p class="label">Total Patients</p>
        <h2>{{ stats?.totalPatients ?? '–' }}</h2>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div>
          <h3>Top Rated Doctors</h3>
          <span class="muted">Based on average rating</span>
        </div>
      </div>
      <div class="panel-body">
        <div *ngIf="topRatedDoctors.length === 0" class="empty">No ratings yet.</div>
        <div class="list">
          <div class="list-item" *ngFor="let doc of topRatedDoctors">
            <div class="avatar" [style.background]="'linear-gradient(135deg, #3b82f6, #2563eb)'">
              {{ doc.first_name[0] }}{{ doc.last_name[0] }}
            </div>
            <div class="info">
              <div class="name">Dr. {{ doc.first_name }} {{ doc.last_name }}</div>
              <div class="meta">{{ doc.speciality }} • {{ doc.email }}</div>
            </div>
            <div class="rating">
              ⭐ {{ doc.rating || 0 | number:'1.1-1' }}
              <span class="muted">({{ doc.total_ratings || 0 }})</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div>
          <h3>Pending Doctor Verifications</h3>
          <span class="muted">Review and approve or reject newly registered doctors</span>
        </div>
      </div>
      <div class="panel-body">
        <div *ngIf="isLoadingDoctors" class="empty">Loading doctors...</div>
        <div *ngIf="!isLoadingDoctors && unverifiedDoctors.length === 0" class="empty">
          No pending verifications.
        </div>
        <div class="list">
          <div class="list-item" *ngFor="let doc of unverifiedDoctors">
            <div class="avatar" [style.background]="'linear-gradient(135deg, #8b5cf6, #7c3aed)'">
              {{ doc.first_name[0] }}{{ doc.last_name[0] }}
            </div>
            <div class="info">
              <div class="name">Dr. {{ doc.first_name }} {{ doc.last_name }}</div>
              <div class="meta">{{ doc.speciality }} • {{ doc.email }}</div>
              <div class="meta muted">License: {{ doc.license_number }}</div>
              <div class="meta muted" *ngIf="doc.hospital_affiliation">Hospital: {{ doc.hospital_affiliation }}</div>
            </div>
            <div class="actions">
              <button class="btn btn-view" (click)="openDetailsModal(doc)">
                View Details
              </button>
              <button 
                class="btn btn-verify" 
                [disabled]="verifyInProgress[doc.doctor_id] || rejectInProgress[doc.doctor_id]" 
                (click)="verifyDoctor(doc)">
                {{ verifyInProgress[doc.doctor_id] ? 'Verifying...' : 'Approve' }}
              </button>
              <button 
                class="btn btn-reject" 
                [disabled]="verifyInProgress[doc.doctor_id] || rejectInProgress[doc.doctor_id]" 
                (click)="openRejectModal(doc)">
                {{ rejectInProgress[doc.doctor_id] ? 'Rejecting...' : 'Reject' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Reject Doctor Modal -->
<div class="modal-overlay" *ngIf="showRejectModal" (click)="closeRejectModal()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Reject Doctor Application</h3>
      <button class="close-btn" (click)="closeRejectModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="doctor-details" *ngIf="selectedDoctor">
        <div class="detail-row">
          <span class="detail-label">Name:</span>
          <span class="detail-value">Dr. {{ selectedDoctor.first_name }} {{ selectedDoctor.last_name }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Email:</span>
          <span class="detail-value">{{ selectedDoctor.email }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Specialty:</span>
          <span class="detail-value">{{ selectedDoctor.speciality }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">License:</span>
          <span class="detail-value">{{ selectedDoctor.license_number }}</span>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Reason for Rejection *</label>
        <textarea 
          class="form-textarea" 
          [(ngModel)]="rejectionReason" 
          placeholder="Please provide a clear reason for rejecting this doctor's application..."
          required></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" (click)="closeRejectModal()">Cancel</button>
        <button 
          class="btn btn-submit" 
          [disabled]="!rejectionReason.trim() || rejectInProgress[selectedDoctor?.doctor_id || 0]"
          (click)="rejectDoctor()">
          {{ rejectInProgress[selectedDoctor?.doctor_id || 0] ? 'Rejecting...' : 'Reject Doctor' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Doctor Details Modal -->
<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Doctor Details</h3>
      <button class="close-btn" (click)="closeDetailsModal()">×</button>
    </div>
    <div class="modal-body" *ngIf="selectedDoctor">
      <div class="doctor-details">
        <div class="detail-row">
          <span class="detail-label">Full Name:</span>
          <span class="detail-value">Dr. {{ selectedDoctor.first_name }} {{ selectedDoctor.last_name }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Email:</span>
          <span class="detail-value">{{ selectedDoctor.email }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Specialty:</span>
          <span class="detail-value">{{ selectedDoctor.speciality }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">License Number:</span>
          <span class="detail-value">{{ selectedDoctor.license_number }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedDoctor.hospital_affiliation">
          <span class="detail-label">Hospital Affiliation:</span>
          <span class="detail-value">{{ selectedDoctor.hospital_affiliation }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedDoctor.bio">
          <span class="detail-label">Bio:</span>
          <span class="detail-value">{{ selectedDoctor.bio }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="detail-value">
            <span [style.color]="selectedDoctor.verified ? '#10b981' : '#f59e0b'">
              {{ selectedDoctor.verified ? 'Verified' : 'Pending Verification' }}
            </span>
          </span>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" (click)="closeDetailsModal()">Close</button>
        <button class="btn btn-verify" (click)="verifyDoctor(selectedDoctor); closeDetailsModal()">
          Approve
        </button>
        <button class="btn btn-reject" (click)="closeDetailsModal(); openRejectModal(selectedDoctor)">
          Reject
        </button>
      </div>
    </div>
  </div>
</div>
