<div class="modal-overlay" *ngIf="isOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Profile Settings</h2>
      <button class="close-btn" (click)="closeModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/>
          <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <!-- Profile Picture Section -->
      <div class="profile-picture-section">
        <div class="profile-picture-container">
          <div class="profile-picture-preview" *ngIf="profilePicturePreview">
            <img [src]="getProfilePictureUrl(profilePicturePreview)" alt="Profile Picture" 
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27100%27 height=%27100%27%3E%3Ccircle cx=%2750%27 cy=%2750%27 r=%2740%27 fill=%27%23e5e7eb%27/%3E%3Ctext x=%2750%27 y=%2755%27 text-anchor=%27middle%27 font-size=%2730%27 fill=%27%239ca3af%27%3E?%3C/text%3E%3C/svg%3E'">
          </div>
          <div class="profile-picture-placeholder" *ngIf="!profilePicturePreview">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
              <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
        </div>
        <div class="profile-picture-actions">
          <label class="btn-upload">
            <input type="file" accept="image/*" (change)="onFileSelected($event)" style="display: none;">
            <span *ngIf="!isUploadingPicture">Upload Photo</span>
            <span *ngIf="isUploadingPicture">Uploading...</span>
          </label>
          <button class="btn-delete" (click)="deleteProfilePicture()" 
                  [disabled]="!profilePicturePreview || isDeletingPicture">
            <span *ngIf="!isDeletingPicture">Delete</span>
            <span *ngIf="isDeletingPicture">Deleting...</span>
          </button>
          <button class="btn-apply" *ngIf="selectedFile" (click)="uploadProfilePicture()" 
                  [disabled]="isUploadingPicture">
            Apply
          </button>
        </div>
      </div>

      <!-- Profile Form -->
      <form class="profile-form" (ngSubmit)="saveProfile()">
        <div class="form-row">
          <div class="form-group">
            <label>First Name *</label>
            <input type="text" [(ngModel)]="profileData.first_name" name="first_name" required>
          </div>
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" [(ngModel)]="profileData.last_name" name="last_name" required>
          </div>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" [(ngModel)]="profileData.email" name="email" disabled>
          <small>Email cannot be changed</small>
        </div>

        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" [(ngModel)]="profileData.contact" name="contact">
        </div>

        <div class="form-group">
          <label>Address</label>
          <textarea [(ngModel)]="profileData.address" name="address" rows="2"></textarea>
        </div>

        <!-- Doctor-specific fields -->
        <div *ngIf="userRole === 'doctor'">
          <div class="form-group">
            <label>Specialty</label>
            <input type="text" [(ngModel)]="profileData.specialty" name="specialty">
          </div>
          <div class="form-group">
            <label>Hospital Affiliation</label>
            <input type="text" [(ngModel)]="profileData.hospital_affiliation" name="hospital_affiliation">
          </div>
          <div class="form-group">
            <label>Bio</label>
            <textarea [(ngModel)]="profileData.bio" name="bio" rows="4"></textarea>
          </div>
        </div>

        <!-- Patient-specific fields -->
        <div *ngIf="userRole === 'patient'">
          <div class="form-row">
            <div class="form-group">
              <label>Gender</label>
              <select [(ngModel)]="profileData.gender" name="gender">
                <option value="">Select Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Blood Type</label>
              <select [(ngModel)]="profileData.blood_type" name="blood_type">
                <option value="">Select Blood Type</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Date of Birth</label>
            <input type="date" [(ngModel)]="profileData.date_of_birth" name="date_of_birth">
          </div>
        </div>

        <!-- Error/Success Messages -->
        <div class="alert alert-error" *ngIf="saveError">
          {{ saveError }}
        </div>
        <div class="alert alert-success" *ngIf="saveSuccess">
          {{ saveSuccess }}
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="closeModal()" [disabled]="isSaving">
            Cancel
          </button>
          <button type="submit" class="btn-primary" [disabled]="isSaving">
            <span *ngIf="!isSaving">Save Changes</span>
            <span *ngIf="isSaving">Saving...</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

