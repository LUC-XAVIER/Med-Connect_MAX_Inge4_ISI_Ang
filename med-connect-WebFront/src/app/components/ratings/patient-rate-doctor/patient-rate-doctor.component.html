<div class="dashboard-wrapper">
  <app-sidebar userRole="patient"></app-sidebar>

  <main class="dashboard-content">
    <div class="header-section">
      <div class="header-top">
        <div class="greeting-section">
          <h1 class="greeting-title">Rate Your Doctors</h1>
          <p class="greeting-subtitle">Share your experience and help others find quality healthcare</p>
        </div>
        <div class="header-actions">
          <button class="btn-notification" title="Notifications" [attr.data-count]="unreadCount > 0 ? unreadCount : null">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span class="notification-count" *ngIf="unreadCount > 0">{{ unreadCount > 99 ? '99+' : unreadCount }}</span>
          </button>
          <div class="user-profile" (click)="openProfileModal()" style="cursor: pointer;">
            <div class="profile-avatar">
              <img *ngIf="currentUser?.profile_picture" 
                    [src]="getProfilePictureUrl(currentUser.profile_picture)" 
                    [alt]="currentUser?.first_name + ' ' + currentUser?.last_name"
                    onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='flex';">
              <svg *ngIf="!currentUser?.profile_picture" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
            <div class="profile-details">
              <span class="profile-name">{{ currentUser?.first_name }} {{ currentUser?.last_name }}</span>
              <span class="profile-role">Patient</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-content-section">
      <div class="glass-card">
        <div *ngIf="isLoading" class="loading-container">
          <div class="spinner"></div>
          <p>Loading doctors...</p>
        </div>

        <div *ngIf="!isLoading && connectedDoctors.length === 0" class="empty-state">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
            <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
          </svg>
          <h3>No Connected Doctors</h3>
          <p>Connect with doctors first to rate them</p>
        </div>

        <div *ngIf="!isLoading && connectedDoctors.length > 0" class="rating-layout">
          <!-- Doctors List -->
          <div class="doctors-list">
            <h3>Select a Doctor</h3>
            <div class="doctors-grid">
              <div *ngFor="let doctor of connectedDoctors"
                   class="doctor-card"
                   [class.selected]="selectedDoctor?.doctor_user_id === doctor.doctor_user_id"
                   (click)="selectDoctor(doctor)">
                <div class="doctor-avatar">
                  {{ doctor.doctor_first_name.charAt(0) }}
                </div>
                <div class="doctor-info">
                  <h4>{{ getDoctorDisplayName(doctor) }}</h4>
                  <p>{{ doctor.doctor_specialty }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Rating Form -->
          <div *ngIf="selectedDoctor" class="rating-form">
            <h3>Rate {{ getDoctorDisplayName(selectedDoctor) }}</h3>
            
            <div class="rating-stars">
              <button *ngFor="let i of [1,2,3,4,5]"
                      type="button"
                      class="star-btn"
                      [class.active]="i <= currentRating"
                      (click)="setRating(i)">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </button>
            </div>
            <p class="rating-label">{{ currentRating === 0 ? 'Select a rating' : currentRating + ' out of 5 stars' }}</p>

            <div class="form-group">
              <label>Review (Optional)</label>
              <textarea
                class="form-control"
                [(ngModel)]="review"
                rows="5"
                placeholder="Share your experience with this doctor..."></textarea>
            </div>

            <div *ngIf="existingRating" class="existing-rating-notice">
              <p>You previously rated this doctor {{ existingRating.rating }} stars</p>
            </div>

            <button class="btn-primary" (click)="submitRating()" [disabled]="currentRating === 0 || isSubmitting">
              {{ isSubmitting ? 'Submitting...' : existingRating ? 'Update Rating' : 'Submit Rating' }}
            </button>
          </div>

          <div *ngIf="!selectedDoctor" class="empty-state-inline">
            <p>Select a doctor from the list to rate them</p>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>



<app-profile-modal 
  [isOpen]="showProfileModal" 
  (close)="closeProfileModal()"
  (profileUpdated)="onProfileUpdated()">
</app-profile-modal>
