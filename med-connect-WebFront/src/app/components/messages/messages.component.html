<div class="dashboard-wrapper">
  <app-sidebar [userRole]="userRole"></app-sidebar>

  <main class="dashboard-content">
    <!-- Header Section -->
    <div class="header-section">
      <div class="header-top">
        <div class="greeting-section">
          <h1 class="greeting-title">Messages</h1>
          <p class="greeting-subtitle">Communicate with your {{ userRole === 'patient' ? 'doctors' : 'patients' }}</p>
        </div>
        <div class="header-actions">
          <button class="btn-notification" title="Notifications" [attr.data-count]="unreadCount > 0 ? unreadCount : null">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span class="notification-count" *ngIf="unreadCount > 0">{{ unreadCount > 99 ? '99+' : unreadCount }}</span>
          </button>
          <div class="user-profile">
            <div class="profile-avatar">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
                <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
            <div class="profile-details">
              <span class="profile-name">{{ currentUser?.first_name }} {{ currentUser?.last_name }}</span>
              <span class="profile-role">{{ userRole | titlecase }}</span>
            </div>
          </div>
          <button class="btn-view-all" (click)="openNewConversationModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 6px;">
              <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2"/>
            </svg>
            New Message
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content-section">
      <div class="messages-layout">
        <!-- Conversations Sidebar -->
        <div class="conversations-sidebar">
          <div class="search-bar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2"/>
            </svg>
            <input
              type="text"
              placeholder="Search conversations..."
              [(ngModel)]="searchQuery"
              (input)="applyFilters()" />
          </div>

          <div class="conversations-list">
            <div *ngIf="isLoading" class="loading-container">
              <div class="spinner"></div>
            </div>

            <div *ngIf="!isLoading && filteredConversations.length === 0" class="empty-state-inline">
              <p>No conversations yet. Start a new message!</p>
            </div>

            <div *ngFor="let conversation of filteredConversations"
                 class="conversation-item"
                 [class.active]="selectedConversation?.conversation_partner_id === conversation.conversation_partner_id"
                 (click)="selectConversation(conversation)">
              <div class="conversation-avatar">
                {{ conversation.conversation_partner_name.charAt(0) }}
              </div>
              <div class="conversation-info">
                <div class="conversation-header">
                  <h4>{{ conversation.conversation_partner_name }}</h4>
                  <span class="conversation-time">{{ formatTime(conversation.last_message_time) }}</span>
                </div>
                <div class="conversation-preview">
                  <p [class.last-message-from-me]="conversation.is_last_message_from_me">
                    {{ conversation.last_message || 'No messages yet' }}
                  </p>
                  <span *ngIf="conversation.unread_count > 0" class="unread-badge">
                    {{ conversation.unread_count }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Messages Area -->
        <div class="messages-area">
          <div *ngIf="!selectedConversation" class="empty-state-center">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2"/>
            </svg>
            <h3>Select a conversation</h3>
            <p>Choose a conversation from the list or start a new one</p>
          </div>

          <div *ngIf="selectedConversation" class="messages-container-wrapper">
            <!-- Conversation Header -->
            <div class="conversation-header-bar">
              <div class="conversation-header-info">
                <div class="conversation-avatar-large">
                  {{ selectedConversation.conversation_partner_name.charAt(0) }}
                </div>
                <div>
                  <h3>{{ selectedConversation.conversation_partner_name }}</h3>
                </div>
              </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container">
              <div *ngIf="isLoadingMessages" class="loading-container">
                <div class="spinner"></div>
              </div>

              <div *ngIf="!isLoadingMessages && messages.length === 0" class="empty-state-inline">
                <p>No messages yet. Start the conversation!</p>
              </div>

              <div *ngFor="let message of messages" 
                   class="message-item"
                   [class.message-sent]="isMyMessage(message)"
                   [class.message-received]="!isMyMessage(message)">
                <div class="message-content">
                  <p>{{ message.message_content }}</p>
                  <span class="message-time">{{ formatTime(message.created_at) }}</span>
                </div>
              </div>
            </div>

            <!-- Message Input -->
            <div class="message-input-container">
              <form (ngSubmit)="sendMessage(); $event.preventDefault()">
                <input
                  type="text"
                  class="message-input"
                  placeholder="Type a message..."
                  [(ngModel)]="messageContent"
                  name="messageContent"
                  [disabled]="isSendingMessage" />
                <button type="submit" class="btn-send" [disabled]="!messageContent.trim() || isSendingMessage">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- New Conversation Modal -->
<div *ngIf="showNewConversationModal" class="modal-overlay" (click)="closeNewConversationModal()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Start New Conversation</h3>
      <button class="close-btn" (click)="closeNewConversationModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div *ngIf="connectedUsers.length === 0" class="empty-state-inline">
        <p>No connected {{ userRole === 'patient' ? 'doctors' : 'patients' }} available.</p>
      </div>
      <div *ngIf="connectedUsers.length > 0" class="users-list">
        <div *ngFor="let user of connectedUsers"
             class="user-item"
             (click)="startNewConversation(user)">
          <div class="user-avatar">
            {{ getUserDisplayName(user).charAt(0) }}
          </div>
          <div class="user-info">
            <h4>{{ getUserDisplayName(user) }}</h4>
            <p *ngIf="userRole === 'patient'">{{ user.doctor_specialty }}</p>
            <p *ngIf="userRole === 'doctor'">{{ user.patient_email }}</p>
          </div>
          <button class="btn-primary">Message</button>
        </div>
      </div>
    </div>
  </div>
</div>

